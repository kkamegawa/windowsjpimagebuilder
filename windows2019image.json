{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "17745664597729549841"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "aibName": {
      "type": "string",
      "defaultValue": "[format('aib-{0}', resourceGroup().name)]"
    },
    "buildMaxTimeout": {
      "type": "int",
      "defaultValue": 240
    },
    "identityType": {
      "type": "string",
      "defaultValue": "UserAssigned"
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D8s_v4"
    },
    "sourceValidationFlag": {
      "type": "bool",
      "defaultValue": false
    },
    "sharedImageRegion": {
      "type": "string",
      "defaultValue": "[parameters('location')]"
    },
    "gallaryImageName": {
      "type": "string",
      "defaultValue": "[format('sig{0}ws2019', resourceGroup().name)]"
    },
    "imageTemplateName": {
      "type": "string",
      "defaultValue": "[format('imageTemplate{0}ws2019', resourceGroup().name)]"
    },
    "AzureComputingGallery": {
      "type": "string",
      "defaultValue": "sig_windows_jpimages"
    },
    "date": {
      "type": "string",
      "defaultValue": "[utcNow('yyyy.MM.ddHHmm')]"
    }
  },
  "variables": {
    "imageFolder": "c:\\images",
    "userIdentityID": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('aibName'))]",
    "galleyImageVersion": "[format('{0}/versions/{1}', resourceId('Microsoft.Compute/galleries/images', split(format('{0}/{1}', parameters('AzureComputingGallery'), parameters('gallaryImageName')), '/')[0], split(format('{0}/{1}', parameters('AzureComputingGallery'), parameters('gallaryImageName')), '/')[1]), parameters('date'))]"
  },
  "resources": [
    {
      "type": "Microsoft.VirtualMachineImages/imageTemplates",
      "apiVersion": "2022-07-01",
      "name": "[parameters('imageTemplateName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Image Builder"
      },
      "identity": {
        "type": "[parameters('identityType')]",
        "userAssignedIdentities": {
          "[format('{0}', variables('userIdentityID'))]": {}
        }
      },
      "properties": {
        "buildTimeoutInMinutes": "[parameters('buildMaxTimeout')]",
        "customize": [
          {
            "name": "InitializeVM",
            "type": "PowerShell",
            "runElevated": true,
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/common/Initialize-VM.ps1",
            "sha256Checksum": "7148640bccbc7b0a99975cbc006c1087f13bc31106b9abfe21fa8a301e7ed552"
          },
          {
            "name": "startup",
            "type": "PowerShell",
            "inline": [
              "[format('New-Item -ItemType Directory -Path {0} -force', variables('imageFolder'))]"
            ],
            "runElevated": false
          },
          {
            "type": "PowerShell",
            "name": "InstallNET48FX",
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/Windows2019/Install-NET48.ps1",
            "sha256Checksum": "670bbb294fc55614979c110a1dfd8938f269ab36b7d4d7a2495b4e6ee4edf8ff"
          },
          {
            "type": "PowerShell",
            "name": "InstallLanguagePack",
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/Windows2019/install-jplangpack.ps1",
            "sha256Checksum": "9671874bd2ac9b95526525fa8343866a930739b55b2e5751ae33c3e9d67ff900",
            "runElevated": true
          },
          {
            "type": "WindowsRestart",
            "restartTimeout": "10m"
          },
          {
            "type": "PowerShell",
            "name": "InstallLanguagePack",
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/Windows2019/install-languagepack.ps1",
            "sha256Checksum": "b927319850cecb2fb87827b5e4d20f997e90b12fce053192e883b9385c4efc42",
            "runElevated": true
          },
          {
            "type": "WindowsRestart",
            "restartTimeout": "10m"
          },
          {
            "type": "PowerShell",
            "name": "InstallNET48FXjp",
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/Windows2019/Install-NET48langpack.ps1",
            "sha256Checksum": "e9a3a3c956e2728faf0a6b2492ca99e8fdf71934f9efc7502a4499ee68d44877"
          },
          {
            "type": "WindowsRestart",
            "restartTimeout": "10m"
          },
          {
            "type": "WindowsUpdate",
            "searchCriteria": "IsInstalled=0",
            "filters": [
              "exclude:$_.Title -like '*Preview*'",
              "include:$true"
            ],
            "updateLimit": 30
          },
          {
            "type": "WindowsRestart",
            "restartTimeout": "40m"
          },
          {
            "name": "RunNGen",
            "type": "PowerShell",
            "runElevated": true,
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/Windows2019/Run-NGen.ps1",
            "sha256Checksum": "cb6563088d5021ee0b309211183cdf01cf74f2cd5afc8ed8d4a2b67294fe9d70"
          },
          {
            "name": "FinalizeVM",
            "type": "PowerShell",
            "runElevated": true,
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/common/Finalize-VM.ps1",
            "sha256Checksum": "a4d93afb23f72fafa8b13285cf56c31975e62a39bb536ec80a4ab6e23b620e32"
          },
          {
            "type": "PowerShell",
            "name": "cleanup",
            "inline": [
              "[format('remove-item -path {0} -recurse -force', variables('imageFolder'))]"
            ]
          }
        ],
        "distribute": [
          {
            "type": "SharedImage",
            "galleryImageId": "[variables('galleyImageVersion')]",
            "runOutputName": "winclient01",
            "artifactTags": {
              "source": "azureVmImageBuilder",
              "baseosimg": "windows2019"
            },
            "replicationRegions": [
              "[parameters('sharedImageRegion')]"
            ]
          }
        ],
        "source": {
          "type": "PlatformImage",
          "publisher": "MicrosoftWindowsServer",
          "offer": "WindowsServer",
          "sku": "2019-datacenter",
          "version": "latest"
        },
        "validate": {
          "continueDistributeOnFailure": false,
          "inVMValidations": [
            {
              "name": "string",
              "type": "PowerShell",
              "inline": [
                "[format('Get-ChildItem -Path {0}', variables('imageFolder'))]"
              ]
            }
          ],
          "sourceValidationOnly": "[parameters('sourceValidationFlag')]"
        },
        "vmProfile": {
          "osDiskSizeGB": 127,
          "userAssignedIdentities": [],
          "vmSize": "[parameters('vmSize')]"
        }
      }
    }
  ]
}