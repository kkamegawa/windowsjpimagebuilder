{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.23.1.45101",
      "templateHash": "2560614546829391236"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "aibName": {
      "type": "string",
      "defaultValue": "[format('aib-{0}', resourceGroup().name)]"
    },
    "buildMaxTimeout": {
      "type": "int",
      "defaultValue": 240
    },
    "identityType": {
      "type": "string",
      "defaultValue": "UserAssigned"
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D4_v4"
    },
    "sourceValidationFlag": {
      "type": "bool",
      "defaultValue": false
    },
    "sharedImageRegion": {
      "type": "string",
      "defaultValue": "[parameters('location')]"
    },
    "gallaryImageName": {
      "type": "string",
      "defaultValue": "[format('sig{0}ws2022', resourceGroup().name)]"
    },
    "imageTemplateName": {
      "type": "string",
      "defaultValue": "[format('imageTemplate{0}ws2022', resourceGroup().name)]"
    },
    "AzureComputingGallery": {
      "type": "string",
      "defaultValue": "sig_windows_jpimages"
    },
    "languagePackStorageAccountName": {
      "type": "string",
      "defaultValue": "publicstorage"
    },
    "languagePackStorageResouceGroup": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]"
    },
    "languagePackISO": {
      "type": "string",
      "defaultValue": "mul_windows_server_2022_languages_optional_features_x64_dvd_08a242b4.iso"
    }
  },
  "variables": {
    "imageFolder": "c:\\images",
    "userIdentityID": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('aibName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.VirtualMachineImages/imageTemplates",
      "apiVersion": "2022-07-01",
      "name": "[parameters('imageTemplateName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Image Builder"
      },
      "identity": {
        "type": "[parameters('identityType')]",
        "userAssignedIdentities": {
          "[format('{0}', variables('userIdentityID'))]": {}
        }
      },
      "properties": {
        "buildTimeoutInMinutes": "[parameters('buildMaxTimeout')]",
        "customize": [
          {
            "name": "InitializeVM",
            "type": "PowerShell",
            "runElevated": true,
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/common/Initialize-VM.ps1",
            "sha256Checksum": "7148640bccbc7b0a99975cbc006c1087f13bc31106b9abfe21fa8a301e7ed552"
          },
          {
            "name": "startup",
            "type": "PowerShell",
            "inline": [
              "[format('New-Item -ItemType Directory -Path {0} -force', variables('imageFolder'))]",
              "[format('$outputPath = join-path {0} -childpath langpack.iso', variables('imageFolder'))]",
              "[format('invoke-webclient -uri {0} -outfile $outputPath -usebasicparsing', format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('languagePackStorageResouceGroup')), 'Microsoft.Storage/storageAccounts', parameters('languagePackStorageAccountName')), '2023-01-01').primaryEndpoints.blob, parameters('languagePackISO')))]"
            ],
            "runElevated": false
          },
          {
            "type": "PowerShell",
            "name": "InstallLanguagePack",
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/Windows2022/install-languagepack.ps1",
            "sha256Checksum": "9b5f273c84eb4d1a43d36c143325dc29a7b470107dfd38bb94d099001149a679"
          },
          {
            "type": "PowerShell",
            "name": "InstallNET481FX",
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/Windows2022/Install-NET481.ps1",
            "sha256Checksum": "deb45ddf190e7d89f58cad38e4873bbc201a723106c660097aa32f40f241fdc5"
          },
          {
            "type": "File",
            "name": "Copysysprep",
            "sourceUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/common/sysprep.ps1",
            "destination": "c:\\DeprovisioningScript.ps1"
          },
          {
            "type": "PowerShell",
            "name": "ChangeLanguage1",
            "inline": [
              "Set-WinUserLanguageList -LanguageList ja-JP,en-US -Force",
              "$LangList = Get-WinUserLanguageList",
              "$MarkedLang = $LangList | where LanguageTag -eq \"en-US\"",
              "$LangList.Remove($MarkedLang)",
              "Set-WinUserLanguageList $LangList -Force"
            ],
            "runElevated": false
          },
          {
            "type": "WindowsRestart",
            "restartTimeout": "5m"
          },
          {
            "type": "PowerShell",
            "name": "InstallNET481FXjp",
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/Windows2022/Install-NET481langpack.ps1",
            "sha256Checksum": "bd586e7c3691ca768e8dc049c8fd58cca935bc4e85b5d34bf5b797960c7e857e"
          },
          {
            "type": "File",
            "name": "SetJaJPWelcome",
            "sourceUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/common/ja-jp-welcome.reg",
            "destination": "[format('{0}\\ja-jp-welcome.reg', variables('imageFolder'))]"
          },
          {
            "type": "File",
            "name": "SetJaJPDefault",
            "sourceUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/common/ja-jp-default.reg",
            "destination": "[format('{0}\\ja-jp-default.reg', variables('imageFolder'))]"
          },
          {
            "type": "PowerShell",
            "name": "ChangeLanguage2",
            "inline": [
              "Set-WinUILanguageOverride -Language ja-JP",
              "Set-WinCultureFromLanguageListOptOut -OptOut $False",
              "Set-WinHomeLocation -GeoId 0x7A",
              "Set-WinSystemLocale -SystemLocale ja-JP",
              "Set-TimeZone -Id \"Tokyo Standard Time\"",
              "Set-Culture ja-JP"
            ],
            "runElevated": false
          },
          {
            "type": "PowerShell",
            "name": "ChangeDefaultLanguage",
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/common/load_registry.ps1",
            "runElevated": false,
            "sha256Checksum": "3ed09b0da5a922f694a2de13f9236a71619f651b2421fe975c448596ac31a806"
          },
          {
            "type": "WindowsRestart",
            "restartTimeout": "10m"
          },
          {
            "type": "WindowsUpdate",
            "searchCriteria": "IsInstalled=0",
            "filters": [
              "exclude:$_.Title -like '*Preview*'",
              "include:$true"
            ],
            "updateLimit": 30
          },
          {
            "type": "WindowsRestart",
            "restartTimeout": "40m"
          },
          {
            "name": "FinalizeVM",
            "type": "PowerShell",
            "runElevated": true,
            "scriptUri": "https://raw.githubusercontent.com/kkamegawa/windowsjpimagebuilder/main/images/common/Finalize-VM.ps1",
            "sha256Checksum": "a4d93afb23f72fafa8b13285cf56c31975e62a39bb536ec80a4ab6e23b620e32"
          },
          {
            "type": "PowerShell",
            "name": "cleanup",
            "inline": [
              "[format('remove-item -path {0} -recurse -force', variables('imageFolder'))]"
            ]
          }
        ],
        "distribute": [
          {
            "type": "SharedImage",
            "galleryImageId": "[resourceId('Microsoft.Compute/galleries/images', split(format('{0}windowslangpack/{1}', parameters('AzureComputingGallery'), parameters('gallaryImageName')), '/')[0], split(format('{0}windowslangpack/{1}', parameters('AzureComputingGallery'), parameters('gallaryImageName')), '/')[1])]",
            "runOutputName": "winclient01",
            "artifactTags": {
              "source": "azureVmImageBuilder",
              "baseosimg": "windows2022"
            },
            "replicationRegions": [
              "[parameters('sharedImageRegion')]"
            ]
          }
        ],
        "source": {
          "type": "PlatformImage",
          "publisher": "MicrosoftWindowsServer",
          "offer": "WindowsServer",
          "sku": "2022-datacenter-azure-edition-hotpatch",
          "version": "latest"
        },
        "validate": {
          "continueDistributeOnFailure": false,
          "inVMValidations": [
            {
              "name": "string",
              "type": "PowerShell",
              "inline": [
                "[format('Get-ChildItem -Path {0}', variables('imageFolder'))]"
              ]
            }
          ],
          "sourceValidationOnly": "[parameters('sourceValidationFlag')]"
        },
        "vmProfile": {
          "osDiskSizeGB": 127,
          "userAssignedIdentities": [],
          "vmSize": "[parameters('vmSize')]"
        }
      }
    }
  ]
}